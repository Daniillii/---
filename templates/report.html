{% extends "base.html" %}

{% block title %}–û—Ç—á—ë—Ç - –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞{% endblock %}

{% block extra_css %}
<style>
    .report-section {
        margin-bottom: 30px;
    }
    
    .metric-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .metric-box.success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .metric-box.warning {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    table th {
        background: #667eea;
        color: white;
        padding: 12px;
        text-align: left;
    }
    
    table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }
    
    table tr:hover {
        background: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<h2 style="margin-bottom: 30px;">üìà –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç</h2>

{% if all_data %}
    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="report-section">
        <h3 style="margin-bottom: 15px;">üìä –û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
        
        {% set total_revenue = all_data | map(attribute='revenue') | sum %}
        {% set total_costs = all_data | map(attribute='fixed_costs') | sum + all_data | map(attribute='variable_costs') | sum %}
        {% set total_profit = all_data | map(attribute='net_profit') | sum %}
        {% set avg_margin = (all_data | map(attribute='profit_margin') | sum) / all_data | length %}
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div class="metric-box">
                <p style="opacity: 0.9;">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</p>
                <p style="font-size: 24px; font-weight: bold;">{{ "%.2f"|format(total_revenue) }} ‚ÇΩ</p>
            </div>
            
            <div class="metric-box warning">
                <p style="opacity: 0.9;">–û–±—â–∏–µ –∏–∑–¥–µ—Ä–∂–∫–∏</p>
                <p style="font-size: 24px; font-weight: bold;">{{ "%.2f"|format(total_costs) }} ‚ÇΩ</p>
            </div>
            
            <div class="metric-box success">
                <p style="opacity: 0.9;">–û–±—â–∞—è —á–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</p>
                <p style="font-size: 24px; font-weight: bold;">{{ "%.2f"|format(total_profit) }} ‚ÇΩ</p>
            </div>
            
            <div class="metric-box">
                <p style="opacity: 0.9;">–°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞ –ø—Ä–∏–±—ã–ª–∏</p>
                <p style="font-size: 24px; font-weight: bold;">{{ "%.2f"|format(avg_margin) }}%</p>
            </div>
        </div>
    </div>
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ –º–µ—Å—è—Ü–∞–º -->
    <div class="report-section">
        <h3 style="margin-bottom: 15px;">üìÖ –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
        
        <table>
            <thead>
                <tr>
                    <th>üìÖ –ü–µ—Ä–∏–æ–¥</th>
                    <th style="text-align: right;">üí∞ –í—ã—Ä—É—á–∫–∞</th>
                    <th style="text-align: right;">üìå –ü–æ—Å—Ç. –∏–∑–¥–µ—Ä–∂–∫–∏</th>
                    <th style="text-align: right;">üìä –ü–µ—Ä. –∏–∑–¥–µ—Ä–∂–∫–∏</th>
                    <th style="text-align: right;">üìà –í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å</th>
                    <th style="text-align: right;">üíµ –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</th>
                    <th style="text-align: center;">%</th>
                </tr>
            </thead>
            <tbody>
                {% for data in all_data %}
                <tr style="{% if data.net_profit < 0 %}background: #ffebee;{% endif %}">
                    <td><strong>{{ data.month }}/{{ data.year }}</strong></td>
                    <td style="text-align: right;">{{ "%.2f"|format(data.revenue) }} ‚ÇΩ</td>
                    <td style="text-align: right;">{{ "%.2f"|format(data.fixed_costs) }} ‚ÇΩ</td>
                    <td style="text-align: right;">{{ "%.2f"|format(data.variable_costs or 0) }} ‚ÇΩ</td>
                    <td style="text-align: right;">{{ "%.2f"|format(data.gross_profit or 0) }} ‚ÇΩ</td>
                    <td style="text-align: right; font-weight: bold; color: {% if data.net_profit >= 0 %}#28a745{% else %}#dc3545{% endif %};">
                        {{ "%.2f"|format(data.net_profit or 0) }} ‚ÇΩ
                    </td>
                    <td style="text-align: center;">{{ "%.1f"|format(data.profit_margin or 0) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ -->
    <div class="report-section">
        <h3 style="margin-bottom: 15px;">üìà –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–∞</h3>
        
        {% set first_month = all_data | first %}
        {% set last_month = all_data | last %}
        {% set revenue_change = ((last_month.revenue - first_month.revenue) / first_month.revenue * 100) if first_month.revenue > 0 else 0 %}
        {% set profit_change = ((last_month.net_profit - first_month.net_profit) / first_month.net_profit * 100) if first_month.net_profit > 0 else 0 %}
        
        <div class="card" style="border-left: 4px solid #667eea;">
            <p><strong>üìä –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Ä—É—á–∫–∏:</strong> 
                <span style="color: {% if revenue_change > 0 %}#28a745{% else %}#dc3545{% endif %};">
                    {% if revenue_change > 0 %}‚Üë{% else %}‚Üì{% endif %} {{ "%.2f"|format(revenue_change) }}%
                </span>
            </p>
            <p style="margin-top: 10px;"><strong>üí∞ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏:</strong> 
                <span style="color: {% if profit_change > 0 %}#28a745{% else %}#dc3545{% endif %};">
                    {% if profit_change > 0 %}‚Üë{% else %}‚Üì{% endif %} {{ "%.2f"|format(profit_change) }}%
                </span>
            </p>
        </div>
    </div>

{% else %}
    <div class="card" style="text-align: center; padding: 60px 20px;">
        <p style="font-size: 48px;">üì≠</p>
        <p style="font-size: 18px; color: #999; margin-bottom: 20px;">–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>
        <a href="/form" class="btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</a>
    </div>
{% endif %}

{% endblock %}